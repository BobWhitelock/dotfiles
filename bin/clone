#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# Clone a GitHub repo into standard directory structure, then create Tmux
# window for new repo. Just open existing repo if already previously cloned.

# XXX Does not work with repos with a `.` as part of the name - e.g. `clone
# https://github.com/junegunn/fzf.vim` will actually clone
# https://github.com/junegunn/fzf.

# Test cases:
# `clone https://github.com/junegunn/fzf`     -> `$SRC/junegunn/fzf`
# `clone git@github.com:junegunn/fzf.git`     -> `$SRC/junegunn/fzf`
# `clone junegunn/fzf`                        -> `$SRC/junegunn/fzf`

main() {
    local repo_identifier owner name repo owner_path

    # Can be URL or just `owner/name`.
    repo_identifier="$1"

    # Extract `owner` and `name` from URLs/repo identifiers in any of the
    # following forms:
    # - https://github.com/owner/name
    # - git@github.com:owner/name.git
    # - owner/name
    owner="$(basename "$(dirname "$repo_identifier")" | awk -F: '{ print $NF }')"
    name="$(basename "$repo_identifier" | cut -d. -f1)"

    # Standardize repo name so `hub` can figure out method should use to clone;
    # avoids being unnecessarily prompted for password.
    repo="$owner/$name"

    owner_path="$SRC/$owner"
    mkdir -p "$owner_path"
    cd "$owner_path"

    if [ ! -d "$name" ]; then
        hub clone "$repo"
    fi

    # shellcheck disable=SC1090
    source "$ZSH_LIB/tmux.sh"
    add_window --vim-pane "$name"
}

main "$@"
